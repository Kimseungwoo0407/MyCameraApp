<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Web Camera App</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; margin-top: 50px; }
    video, canvas { width: 320px; height: 240px; border: 1px solid #ccc; }
    button { margin: 10px 5px; padding: 10px 20px; font-size: 16px; }
    #init { display: block; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>ê°„ë‹¨ ì›¹ ì¹´ë©”ë¼ ì•±</h1>
  <!-- ì‚¬ìš©ì í´ë¦­ìœ¼ë¡œ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ -->
  <button id="init">ì¹´ë©”ë¼ ì‹œì‘</button>
  <video id="video" autoplay playsinline muted style="display:none"></video><br>
  <button id="switch" style="display:none">ì¹´ë©”ë¼ ì „í™˜</button>
  <button id="capture" style="display:none">ì‚¬ì§„ ì°ê¸°</button>
  <button id="send" style="display:none">ì „ì†¡</button><br>
  <canvas id="canvas" width="320" height="240"></canvas>

  <script>
    const initButton = document.getElementById('init');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('capture');
    const switchButton = document.getElementById('switch');
    const sendButton = document.getElementById('send');
    let currentStream = null;
    let useFront = true;
    let lastDataURL = null;

    async function startCamera() {
      try {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        const constraints = { audio: false, video: { facingMode: useFront ? 'user' : 'environment' } };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.style.display = 'block';
        switchButton.style.display = 'inline-block';
        captureButton.style.display = 'inline-block';
        sendButton.style.display = 'inline-block';
        video.srcObject = currentStream;
        await video.play();
      } catch (err) {
        console.error('ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜:', err);
        alert('ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.');
      }
    }

    initButton.addEventListener('click', async () => {
      await startCamera();
      initButton.style.display = 'none';
    });

    switchButton.addEventListener('click', () => {
      useFront = !useFront;
      startCamera();
    });

    captureButton.addEventListener('click', () => {
      if (!currentStream) return alert('ì¹´ë©”ë¼ë¥¼ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.');
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      lastDataURL = canvas.toDataURL('image/png');
      console.log('Captured image');
      alert('ì‚¬ì§„ ìº¡ì²˜ ì™„ë£Œ');
    });

    sendButton.addEventListener('click', async () => {
  if (!lastDataURL) return alert('ë¨¼ì € ì‚¬ì§„ì„ ì°ì–´ì£¼ì„¸ìš”.');

  try {
    const response = await fetch('https://8aa24c87832ef6.lhr.life/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: lastDataURL })
    });

    const result = await response.json();

    if (!response.ok || result.error) {
      // ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
      alert(`âŒ ì˜ˆì¸¡ ì‹¤íŒ¨: ${result.message || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'}`);
    } else {
      // ì •ìƒ ì‘ë‹µ ì²˜ë¦¬
      alert(`ğŸ½ ì˜ˆì¸¡ ê²°ê³¼: ${result.prediction.label} (${(result.prediction.confidence * 100).toFixed(1)}%)`);
    }
  } catch (err) {
    console.error('ì „ì†¡ ì˜ˆì™¸:', err);
    alert(`ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
  }
});
  </script>
</body>
</html>
